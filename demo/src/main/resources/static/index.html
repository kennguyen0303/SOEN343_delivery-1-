<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <title>Smart Home Simulator</title>
    <!-- Custom styles for this template -->
    <link href="style.css" rel="stylesheet">
  </head>

  <header>

  </header>

  <body>
    <div class="layout-container">
        <div class="sidebar">
            <fieldset id="simulationTab">
              <legend id="simlegend">Simulation</legend>
      
              <!-- On/off switch-->
              <div class="row justify-content-center">
                <label class="switch">
                  <input type="checkbox" >
                  <span class="slider round">ON</span>
                </label>
              </div>
              <!-- /On/off switch-->
      
              <!-- edit icon-->
              <div class="row justify-content-center">
                <a href="#"> <img src="edit.png" alt="edit" id="editIcon"></a>
              </div>
              <!-- /edit icon-->
      
              <!-- Profile picture-->
              <div class="row justify-content-center" id="profilePic">
      
              </div>
              <!-- /Profile picture-->
      
              <!-- User-->
              <div class="row justify-content-center">
                  <a href="#" style="text-decoration:underline;" >Parent</a>
              </div>
              <!-- /User-->
      
              <!-- Location-->
              <div class="row justify-content-center" style="font-weight:600;">
                Location:
              </div>
      
              <div class="row justify-content-center">
                <a href="#" style="text-decoration:underline;">Kitchen</a>
              </div>
              <!-- /Location-->
      
              <!--Temperature -->
              <div class="row justify-content-center" style="font-weight:700;">
                Outside Temp. 15 &#730;C
              </div>
              <!--/Temperature -->
      
            </fieldset>
          </div>
          <div class="tab-items">
              <div class="tabs">
                  <button class="tabLink" onclick="changeTabs(event, 'SHSystem')" id="defaultOpen">SHS</button>
                  <button class="tabLink" onclick="changeTabs(event, 'SHCore')">SHC</button>
                  <button class="tabLink" onclick="changeTabs(event, 'SHProtection')">SHP</button>
                  <button class="tabLink" onclick="changeTabs(event, 'SHHeating')">SHH</button>
              </div>
      
              <div id="SHSystem" class="tabcontent">
                  Smart Home System Components
              </div>
      
              <div id="SHCore" class="tabcontent">
                  Smart Home Core Components
              </div>
      
              <div id="SHProtection" class="tabcontent">
                  Smart Home Protection Components
              </div>
      
              <div id="SHHeating" class="tabcontent">
                  Smart Home Heating Components
              </div>
      
          </div>
          <div class="house-diagram">
              <button onclick="renderLayout()">Click to render the layout</button>
        
              <canvas id="myCanvas" width="500" height="400"
          style="border:1px solid black;">
          Your browser does not support the canvas element.
          </canvas>
             <h3>Controlling: </h3>
             <select name="" id="control_option">
                 <option value="1">1</option>
                 <option value="2">2</option>
                 <option value="3">3</option>
                 <option value="4">4</option>
             </select>
             <h4>Use arrow button to move </h4>
          </div>
          <div class = "console">Console Here</div>
    </div>
<!--    <div class="Daniela-test">-->
<!--        <form action="">-->
<!--            <select name="roles" onchange="addProfile(this.value)">-->
<!--                <option value="Parent">Parent</option>-->
<!--                <option value="Child">Child</option>-->
<!--                <option value="Guest">Guest</option>-->
<!--                <submit>Submit</submit>-->
<!--            </select>-->
<!--        </form>-->
<!--        <button onclick="getProfile()">Click to get the profiles</button>-->
<!--        <div id="showProfile"></div>-->
<!--    </div>-->
    

  <script>
    /**
    *Header 
    *@return a layout
    */
    var door_array=[];//the array for doors !
   function renderLayout()//a function for rendering the layout of the house
   {
        var xmlhttp = new XMLHttpRequest();//creating a request for AJAX to load the layout
            xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {//when the layout file is successfully loaded, executes the below codes
                myObj = JSON.parse(this.responseText);//parse the JSON data to an JAvascript object
                var canvas = document.getElementById("myCanvas");//define the area to draw
                var ctx = canvas.getContext("2d");//a syntax concept, check the w3school
                //drawing starts here
                for (var key1 of Object.keys(myObj)) {//loop over each room in the JSON file, syntax here: loop over an object
                    for (var key2 of Object.keys(myObj[key1])) {//loop over each element of a room
                        //print room_name p/s: hardcode name position need to fix later
                        if(key2=="name"){//if the element is "name", need to print out
                            ctx.font = "15px Arial";//set the font
                            ctx.fillText(myObj[key1][key2][0],myObj[key1][key2][1],myObj[key1][key2][2]);//format: [0]=room name, [1]: width, [2]: height
                        }
                        //print the door
                        if(key1=="door"){
                            //each [key2] is an object of a door
                            var temp_door = new door(myObj[key1][key2][0], myObj[key1][key2][1], myObj[key1][key2][2], myObj[key1][key2][3], myObj[key1][key2][4],myObj[key1][key2][5]);
                            door_array.push(temp_door);
                            continue;
                        }
                        //draw the wall for a room
                        for(var i=0;i<myObj[key1][key2].length;i=i+4){
                            ctx.moveTo(myObj[key1][key2][i],myObj[key1][key2][i+1]);
                            ctx.lineTo(myObj[key1][key2][i+2],myObj[key1][key2][i+3]);
                            ctx.stroke();
                        }
                    };//finish rendering a room
                };
                startGame();//start the movement, challenge: Need to click to render door
            }
        };
        xmlhttp.open("GET", "layout.json", true);
        xmlhttp.send();
            
   }
   //try the game code from w3school with some modification, check w3school for more detials
  
   var option;
function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.getElementById("myCanvas"),
    start : function() {
        this.context = this.canvas.getContext("2d");
        this.interval;
        updateGameArea();
        window.addEventListener('keydown', function (e) {
            myGameArea.key = e.keyCode;
            this.interval = setInterval(updateGameArea, 20);
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.key = false;
            clearInterval(this.interval);//let's try
        })
    }, 
    clear : function(){
        door_array.forEach(a_door => {
            if(a_door.move_mode=="horizontal") this.context.clearRect((a_door.x-40), a_door.y, 60, 5);
            if(a_door.move_mode=="vertical") this.context.clearRect(a_door.x, (a_door.y-40), 5, 60);
        });
    }
}
//a constructor
function door(width, height, color, x, y,move_mode) {
    this.gamearea = document.getElementById("myCanvas");
    this.move_mode=move_mode;
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;    
    this.x = x;
    this.y = y;
    if(this.move_mode=="horizontal"){//make a boundary for movement
        this.boundary=[this.x,(this.x+this.width)];//inital point + width
    }
    if(this.move_mode=="vertical"){//make a boundary for movement
        this.boundary=[this.y,(this.y+this.height)]
    }        
    this.update = function() {
        ctx = this.gamearea.getContext("2d")
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    this.newPos = function() {
        this.x += this.speedX;
        this.y += this.speedY;        
    }
}

function updateGameArea() {
    myGameArea.clear(); 
    door_array.forEach(a_door => {
        a_door.speedX=0;
        a_door.speedY=0;
    });
    var option = document.getElementById("control_option").value - 1;//minus 1 since array start from 0
    if (myGameArea.key && myGameArea.key == 37) {//move left
        if(door_array[option].move_mode=="horizontal")
            if(door_array[option].x>door_array[option].boundary[0]) door_array[option].speedX = -1;
         }
    if (myGameArea.key && myGameArea.key == 38) {//move up
        if(door_array[option].move_mode=="vertical") 
        if(door_array[option].y>door_array[option].boundary[0]) door_array[option].speedY = -1;
        }  
    if (myGameArea.key && myGameArea.key == 39) {//move right
        if(door_array[option].move_mode=="horizontal") 
        if(door_array[option].x<door_array[option].boundary[1]) door_array[option].speedX = 1;
    }
    if (myGameArea.key && myGameArea.key == 40) {//move down
        if(door_array[option].move_mode=="vertical") 
        if(door_array[option].y<door_array[option].boundary[1]) door_array[option].speedY = 1;
    
    }
        
    //key in control is the update function
    //update the now position for every door, otherwise it will not be shown
    door_array.forEach(a_door => {
        a_door.newPos();    
        a_door.update();
    });
}
    </script>
    <script type="text/javascript">
		document.getElementById("defaultOpen").click();

		function changeTabs(evt, SmartHomeTab) {
			// Declare all variables
			var i, tabcontent, tablinks;

			// Get all elements with class="tabcontent" and hide them
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++) {
			  tabcontent[i].style.display = "none";
			}

			// Get all elements with class="tablinks" and remove the class "active"
			tablinks = document.getElementsByClassName("tablinks");
			for (i = 0; i < tablinks.length; i++) {
			  tablinks[i].className = tablinks[i].className.replace(" active", "");
			}

			// Show the current tab, and add an "active" class to the button that opened the tab
			document.getElementById(SmartHomeTab).style.display = "block";
			evt.currentTarget.className += " active";
		}
    </script>
    <script>
        function addProfile(str) {
          var xhttp;
          alert(str);
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
             alert("added successfully");
          };
          }
          var obj = { "role" : str};
          obj = JSON.stringify(obj);
          console.log(obj);
          xhttp.open("POST", "http://localhost:8080/api/user", true);
          xhttp.setRequestHeader("Content-type", "application/json");
          xhttp.send(obj);

        }
        //get the profile !
        function getProfile() {
          var xhttp;
            window.alert("inside getProfile");
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
             document.getElementById("showProfile").innerHTML=this.responseText;
          };
          }
          xhttp.open("GET", "http://localhost:8080/api/user", true);
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send();

        }
        </script>
<h2>User Management</h2>

<!--Add a user profile-->
<div name="createForm">
    <p>Add a new role:</p>
    <select name="roles" id="roleSelect">
        <option value="Parent">Parent</option>
        <option value="Child">Child</option>
        <option value="Guest">Guest</option>
    </select>
    <input type="button" onclick="onAddUserSubmit()" value="Add user">
</div>

<br>
<br>

<!--Edit a user profile-->
<div name="editForm">
    <div>Current Registered Users</div>
    <div id="availableUsers">
        <select id="currentUsersList"></select>
    </div>
    <br>
    <div>Enter a new role:
        <input type="text" id="newRole">
    </div>

    <br>
    <input type="button" value="Edit Selected User" onclick="onSubmitEditForm()">
    <input type="button" value="Delete Selected User" onclick="onSubmitDeleteUser()">
</div>

<!--Delete a user profile-->
<div id="deleteForm">

</div>
<br>

<!--Time-->
<form onsubmit="startTime(true)">
    <input id="calendar" type="date">
</form>
<div id="time"></div>
<script>
var loggedUserId;
var date = new Date();

function removeAllChildNodes(element) {
    while(element.firstChild) {
        element.removeChild(element.lastChild);
    }
}

function getUserById(id) {
      var xhttp;
      var user;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            user = JSON.parse(this.responseText);
        }
      };

      xhttp.open("GET", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send();
}

function getUsers() {
  var xhttp;
  var userArray;
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {

   if (this.readyState == 4 && this.status == 200) {
      userArray = JSON.parse(this.responseText);

      var select = document.getElementById("currentUsersList")
      removeAllChildNodes(select);

      for( var i=0; i< userArray.length; i++) {
        var option = document.createElement("option");
        option.value = userArray[i].id;
        option.innerHTML = userArray[i].role;

        select.appendChild(option);
      }

      var item = document.getElementById("availableUsers");

      removeAllChildNodes(item);
      item.appendChild(select);
    }
  };

  xhttp.open("GET", "http://localhost:8080/api/user", true);
  xhttp.send();
}

function onAddUserSubmit() {

  var select = document.getElementById("roleSelect");
  var role = select.options[select.selectedIndex].value;
  addUser(role);
}

function addUser(str) {
  var xhttp;
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        getUsers();
    }
  };

  var obj = { "role" : str};
  obj = JSON.stringify(obj);
  xhttp.open("POST", "http://localhost:8080/api/user", true);
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send(obj);
}

function onSubmitDeleteUser()
{
   var select = document.getElementById("currentUsersList");
   var userId = select.options[select.selectedIndex].value;

   deleteUser(userId);
}

function deleteUser(id) {
      var xhttp;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            getUsers();
        }
      };

      xhttp.open("DELETE", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send();
}

function onSubmitEditForm() {
   var select = document.getElementById("currentUsersList");
   var userId = select.options[select.selectedIndex].value;
   var newRole = document.getElementById("newRole").value;
   var currentRole = getUserById(userId);

   editUser(newRole, userId);
}

function editUser(newRole, id) {
      var xhttp;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            getUsers();
        }
      };

      var obj = { "role" : newRole};
      obj = JSON.stringify(obj);
      xhttp.open("PUT", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send(obj);
}

//Time
function startTime(fromSubmit) {

  if(fromSubmit)
  {
      var calendar = document.getElementById("calendar").value;
      date.setDate(calendar)
      today.setHours(hours)
      today.setMinutes(minutes);
      today.setSeconds(seconds);
  }

  var month = today.getMonth();
  var day = today.getDay();
  var year = today.getYear();
  var hour = today.getHours();
  var minute = today.getMinutes();
  var second = today.getSeconds();
  m = checkTime(m);
  s = checkTime(s);
  document.getElementById('time').innerHTML =
  day + month+ year+","+ hour + ":" + minute + ":" + second;
  var t = setTimeout(startTime, 500);
}

function checkTime(i) {
  if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
  return i;
}
</script>
</body>
</html>
