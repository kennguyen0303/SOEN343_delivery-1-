<!DOCTYPE html>
<html>
<style>
table,th,td {
  border : 1px solid black;
  border-collapse: collapse;
}
th,td {
  padding: 5px;
}
</style>
<body>

<h2>User</h2>

<form name="roleSelect" action="" method = "Post">
    <p>Add a new role:</p>
    <select name="roles" onchange="onClick(this.value)">
        <option value="Parent">Parent</option>
        <option value="Child">Child</option>
        <option value="Guest">Guest</option>
    </select>
</form>
<br>
<br>
<form onsubmit="onSubmitEditForm()">
    <div>Current Registered Users</div>
    <div id="availableUsers">
        <select id="currentUsersList"></select>
    </div>
    <br>
    <p>Enter a new role: </p>
    <input type="text" id="newRole"></input>
    <br>
    <input type="submit">
</form>
<script>
var loggedUserId;

function onClick(str) {
  var xhttp;
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        getUsers();
    }
  };

  var obj = { "role" : str};
  obj = JSON.stringify(obj);
  xhttp.open("POST", "http://localhost:8080/api/user", true);
  xhttp.setRequestHeader("Content-type", "application/json");
  xhttp.send(obj);
}

function getUsers() {
  var xhttp;
  var userArray;
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {

   if (this.readyState == 4 && this.status == 200) {
      userArray = JSON.parse(this.responseText);

      var select = document.getElementById("currentUsersList")

      for( var i=0; i< userArray.length; i++) {
        var option = document.createElement("option");
        option.value = userArray[i].id;
        option.innerHTML = userArray[i].role;

        select.appendChild(option);
      }

      var item = document.getElementById("availableUsers");
      removeAllChildNodes(item);
      item.appendChild(select);
    }
  };

  xhttp.open("GET", "http://localhost:8080/api/user", true);
  xhttp.send();
}

function onDelete() {
}

function editUser(newRole, id) {
      var xhttp;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
        }
      };

      var obj = { "role" : newRole};
      obj = JSON.stringify(obj);
      xhttp.open("PUT", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send(obj);
}

function deleteUser(id) {
      var xhttp;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            getUsers();
        }
      };

      xhttp.open("DELETE", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send();
}

function removeAllChildNodes(element) {
    while(element.firstChild) {
        element.removeChild(element.lastChild);
    }
}

function getUserById(id)
{
      var xhttp;
      var user;
      xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            user = JSON.parse(this.responseText);
        }
      };

      xhttp.open("GET", "http://localhost:8080/api/user/" + id, true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send();
}

function onSubmitEditForm() {
   var select = document.getElementById("currentUsersList");
   console.log()
   var userId = select.options[select.selectedIndex].value;
   var newRole = document.getElementById("newRole").value;
   var currentRole = getUserById(userId);

   editUser(newRole, userId);
   getUsers();
}
</script>
</body>
</html>
