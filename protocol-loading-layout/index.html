<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play with this page ! </title>
</head>
<body>
    <button onclick="renderLayout()">Click to render the layout</button>
  
    <canvas id="myCanvas" width="500" height="400"
style="border:1px solid black;">
Your browser does not support the canvas element.
</canvas>
   <h3>Controlling: </h3>
   <select name="" id="control_option">
       <option value="1">1</option>
       <option value="2">2</option>
       <option value="3">3</option>
       <option value="4">4</option>
   </select>
   <h4>Use arrow button to move </h4>
   <script>
    /**
    *Header 
    *@return a layout
    */
    var door_array=[];//the array for doors !
   function renderLayout()//a function for rendering the layout of the house
   {
        var xmlhttp = new XMLHttpRequest();//creating a request for AJAX to load the layout
            xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {//when the layout file is successfully loaded, executes the below codes
                myObj = JSON.parse(this.responseText);//parse the JSON data to an JAvascript object
                var canvas = document.getElementById("myCanvas");//define the area to draw
                var ctx = canvas.getContext("2d");//a syntax concept, check the w3school
                //drawing starts here
                for (var key1 of Object.keys(myObj)) {//loop over each room in the JSON file, syntax here: loop over an object
                    for (var key2 of Object.keys(myObj[key1])) {//loop over each element of a room
                        //print room_name p/s: hardcode name position need to fix later
                        if(key2=="name"){//if the element is "name", need to print out
                            ctx.font = "15px Arial";//set the font
                            ctx.fillText(myObj[key1][key2][0],myObj[key1][key2][1],myObj[key1][key2][2]);//format: [0]=room name, [1]: width, [2]: height
                        }
                        //print the door
                        if(key1=="door"){
                            //each [key2] is an object of a door
                            var temp_door = new door(myObj[key1][key2][0], myObj[key1][key2][1], myObj[key1][key2][2], myObj[key1][key2][3], myObj[key1][key2][4],myObj[key1][key2][5]);
                            door_array.push(temp_door);
                            continue;
                        }
                        //draw the wall for a room
                        for(var i=0;i<myObj[key1][key2].length;i=i+4){
                            ctx.moveTo(myObj[key1][key2][i],myObj[key1][key2][i+1]);
                            ctx.lineTo(myObj[key1][key2][i+2],myObj[key1][key2][i+3]);
                            ctx.stroke();
                        }
                    };//finish rendering a room
                };
                startGame();//start the movement, challenge: Need to click to render door
            }
        };
        xmlhttp.open("GET", "layout.json", true);
        xmlhttp.send();
            
   }
   //try the game code from w3school with some modification, check w3school for more detials
  
   var option;
function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.getElementById("myCanvas"),
    start : function() {
        this.context = this.canvas.getContext("2d");
        this.interval;
        updateGameArea();
        window.addEventListener('keydown', function (e) {
            myGameArea.key = e.keyCode;
            this.interval = setInterval(updateGameArea, 20);
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.key = false;
            clearInterval(this.interval);//let's try
        })
    }, 
    clear : function(){
        door_array.forEach(a_door => {
            if(a_door.move_mode=="horizontal") this.context.clearRect((a_door.x-40), a_door.y, 60, 5);
            if(a_door.move_mode=="vertical") this.context.clearRect(a_door.x, (a_door.y-40), 5, 60);
        });
    }
}
//a constructor
function door(width, height, color, x, y,move_mode) {
    this.gamearea = document.getElementById("myCanvas");
    this.move_mode=move_mode;
    this.width = width;
    this.height = height;
    this.speedX = 0;
    this.speedY = 0;    
    this.x = x;
    this.y = y;
    if(this.move_mode=="horizontal"){//make a boundary for movement
        this.boundary=[this.x,(this.x+this.width)];//inital point + width
    }
    if(this.move_mode=="vertical"){//make a boundary for movement
        this.boundary=[this.y,(this.y+this.height)]
    }        
    this.update = function() {
        ctx = this.gamearea.getContext("2d")
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    this.newPos = function() {
        this.x += this.speedX;
        this.y += this.speedY;        
    }
}

function updateGameArea() {
    myGameArea.clear(); 
    door_array.forEach(a_door => {
        a_door.speedX=0;
        a_door.speedY=0;
    });
    var option = document.getElementById("control_option").value - 1;//minus 1 since array start from 0
    if (myGameArea.key && myGameArea.key == 37) {//move left
        if(door_array[option].move_mode=="horizontal")
            if(door_array[option].x>door_array[option].boundary[0]) door_array[option].speedX = -1;
         }
    if (myGameArea.key && myGameArea.key == 38) {//move up
        if(door_array[option].move_mode=="vertical") 
        if(door_array[option].y>door_array[option].boundary[0]) door_array[option].speedY = -1;
        }  
    if (myGameArea.key && myGameArea.key == 39) {//move right
        if(door_array[option].move_mode=="horizontal") 
        if(door_array[option].x<door_array[option].boundary[1]) door_array[option].speedX = 1;
    }
    if (myGameArea.key && myGameArea.key == 40) {//move down
        if(door_array[option].move_mode=="vertical") 
        if(door_array[option].y<door_array[option].boundary[1]) door_array[option].speedY = 1;
    
    }
        
    //key in control is the update function
    //update the now position for every door, otherwise it will not be shown
    door_array.forEach(a_door => {
        a_door.newPos();    
        a_door.update();
    });
}
    </script>
</body>
</html>